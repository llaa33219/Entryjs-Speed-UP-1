<!DOCTYPE html>
<html lang="ko">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Entry.js OnlyRun Mode</title>
    <link href="dist/entry.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .loading-detail {
            font-size: 14px;
            opacity: 0.8;
        }
        
        #error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .error-message {
            font-size: 16px;
            opacity: 0.9;
            max-width: 600px;
            line-height: 1.5;
        }
        
        #workspace {
            width: 100vw;
            height: 100vh;
            display: none;
        }
        
        /* Entry.js ìŠ¤í…Œì´ì§€ë¥¼ ì „ì²´ í™”ë©´ìœ¼ë¡œ */
        .entryStageWrapper {
            width: 100% !important;
            height: 100% !important;
        }
        
        .entryStage {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* ë¶ˆí•„ìš”í•œ UI ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸° */
        .entryPlayground,
        .entryPropertyPanel,
        .entryMenubar,
        .entryToolbar {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="loading-detail">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>
    
    <!-- ì—ëŸ¬ í™”ë©´ -->
    <div id="error">
        <div class="error-icon">âš ï¸</div>
        <div class="error-title">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="error-message" id="error-message">
            ì˜¬ë°”ë¥¸ í”„ë¡œì íŠ¸ IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.<br>
            ì‚¬ìš©ë²•: /onlyrun/í”„ë¡œì íŠ¸ID
        </div>
    </div>
    
    <!-- Entry.js ì›Œí¬ìŠ¤í˜ì´ìŠ¤ -->
    <div id="workspace"></div>

    <!-- Entry.js ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ -->
    <script src="extern/lang/ko.js"></script>
    <script src="https://playentry.org/lib/PreloadJS/lib/preloadjs-0.6.0.min.js"></script>
    <script src="https://playentry.org/lib/EaselJS/lib/easeljs-0.8.0.min.js"></script>
    <script src="https://playentry.org/lib/SoundJS/lib/soundjs-0.6.0.min.js"></script>
    <script src="https://playentry.org/lib/SoundJS/lib/flashaudioplugin-0.6.0.min.js"></script>
    <script src="https://playentry.org/lib/lodash/dist/lodash.min.js"></script>
    <script src="https://playentry.org/lib/jquery/jquery.min.js"></script>
    <script src="https://playentry.org/lib/jquery-ui/ui/minified/jquery-ui.min.js"></script>
    <script src="https://playentry.org/lib/velocity/velocity.min.js"></script>
    <script src="extern/util/static.js"></script>
    <script src="dist/entry.js"></script>

    <script>
        // OnlyRun ëª¨ë“œ êµ¬í˜„
        class OnlyRunMode {
            constructor() {
                this.projectId = null;
                this.loadingEl = document.getElementById('loading');
                this.errorEl = document.getElementById('error');
                this.workspaceEl = document.getElementById('workspace');
                this.errorMessageEl = document.getElementById('error-message');
            }
            
            // URLì—ì„œ í”„ë¡œì íŠ¸ ID ì¶”ì¶œ
            extractProjectId() {
                const path = window.location.pathname;
                const match = path.match(/\/onlyrun\/([a-zA-Z0-9]+)/);
                return match ? match[1] : null;
            }
            
            // ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
            updateLoadingText(text, detail = '') {
                document.querySelector('.loading-text').textContent = text;
                document.querySelector('.loading-detail').textContent = detail;
            }
            
            // ì—ëŸ¬ í‘œì‹œ
            showError(message) {
                this.errorMessageEl.innerHTML = message;
                this.loadingEl.style.display = 'none';
                this.errorEl.style.display = 'flex';
            }
            
            // ì´ë¯¸ì§€ íŒŒì¼ëª…ì„ ì ˆëŒ€ URLë¡œ ë³€í™˜
            convertImageUrl(filename) {
                if (!filename || filename.length < 4) return filename;
                
                const prefix1 = filename.substring(0, 2);
                const prefix2 = filename.substring(2, 4);
                const extension = filename.split('.').pop() || 'png';
                
                return `https://playentry.org/uploads/${prefix1}/${prefix2}/image/${filename}`;
            }
            
            // í”„ë¡œì íŠ¸ ë°ì´í„°ì—ì„œ ì´ë¯¸ì§€ URL ë³€í™˜
            processProjectData(projectData) {
                if (!projectData || !projectData.objects) return projectData;
                
                // ì˜¤ë¸Œì íŠ¸ë“¤ì˜ ì´ë¯¸ì§€ íŒŒì¼ëª…ì„ ì ˆëŒ€ URLë¡œ ë³€í™˜
                projectData.objects.forEach(obj => {
                    if (obj.sprite && obj.sprite.pictures) {
                        obj.sprite.pictures.forEach(picture => {
                            if (picture.filename) {
                                picture.fileurl = this.convertImageUrl(picture.filename);
                            }
                        });
                    }
                    if (obj.sprite && obj.sprite.sounds) {
                        obj.sprite.sounds.forEach(sound => {
                            if (sound.filename) {
                                sound.fileurl = this.convertImageUrl(sound.filename);
                            }
                        });
                    }
                });
                
                return projectData;
            }
            
            // Entry.org GraphQL APIë¡œ í”„ë¡œì íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            async fetchProject(projectId) {
                const query = `
                    query SELECT_PROJECT($id: ID! $groupId: ID) {
                        project(id: $id, groupId: $groupId) {
                            id
                            name
                            user {
                                id
                                nickname
                                profileImage {
                                    id
                                    name
                                    filename
                                    imageType
                                    dimension {
                                        width
                                        height
                                    }
                                }
                            }
                            thumb
                            isopen
                            category
                            created
                            updated
                            visit
                            likeCnt
                            comment
                            description
                            speed
                            objects
                            variables
                            messages
                            functions
                            tables
                            scenes
                            expansionBlocks
                            aiUtilizeBlocks
                        }
                    }
                `;
                
                const response = await fetch('https://playentry.org/graphql/SELECT_PROJECT', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: { id: projectId }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.errors) {
                    throw new Error(result.errors[0].message);
                }
                
                if (!result.data || !result.data.project) {
                    throw new Error('í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                return result.data.project;
            }
            
                         // Entry.js ì´ˆê¸°í™”
             initEntry() {
                 return new Promise((resolve, reject) => {
                     try {
                         const initOption = {
                             type: 'workspace', // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª¨ë“œë¡œ ì´ˆê¸°í™” í›„ UI ìˆ¨ê¹€
                             libDir: '',
                             entryDir: '',
                             textCodingEnable: false,
                             hardwareEnable: false,
                         };
                         
                         Entry.init(this.workspaceEl, initOption);
                         
                         // UI ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
                         setTimeout(() => {
                             this.hideUIElements();
                             resolve();
                         }, 1500);
                         
                     } catch (error) {
                         reject(error);
                     }
                 });
             }
             
             // UI ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
             hideUIElements() {
                 const elementsToHide = [
                     '.entryPlayground',
                     '.entryPropertyPanel', 
                     '.entryMenubar',
                     '.entryToolbar',
                     '.entryCanvasWrapper .entryCanvasWorkspace',
                     '.entryWorkspaceBoard',
                     '.entryBlocklyWorkspace'
                 ];
                 
                 elementsToHide.forEach(selector => {
                     const elements = document.querySelectorAll(selector);
                     elements.forEach(el => {
                         el.style.display = 'none';
                     });
                 });
                 
                 // ìŠ¤í…Œì´ì§€ë§Œ ì „ì²´ í™”ë©´ìœ¼ë¡œ í‘œì‹œ
                 const stage = document.querySelector('.entryCanvasStage');
                 if (stage) {
                     stage.style.position = 'fixed';
                     stage.style.top = '0';
                     stage.style.left = '0';
                     stage.style.width = '100vw';
                     stage.style.height = '100vh';
                     stage.style.zIndex = '1000';
                 }
             }
            
            // í”„ë¡œì íŠ¸ ë¡œë“œ ë° ì‹¤í–‰
            async loadAndRunProject(projectData) {
                try {
                    // í”„ë¡œì íŠ¸ ë°ì´í„° ì²˜ë¦¬
                    const processedData = this.processProjectData(projectData);
                    
                    // Entry.jsì— í”„ë¡œì íŠ¸ ë¡œë“œ
                    Entry.loadProject(processedData);
                    
                    // ìë™ ì‹¤í–‰
                    setTimeout(() => {
                        if (Entry.engine) {
                            Entry.engine.run();
                        }
                    }, 500);
                    
                    // UI ì „í™˜
                    this.loadingEl.style.display = 'none';
                    this.workspaceEl.style.display = 'block';
                    
                } catch (error) {
                    throw new Error(`í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                }
            }
            
            // ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
            async run() {
                try {
                    // 1. í”„ë¡œì íŠ¸ ID ì¶”ì¶œ
                    this.projectId = this.extractProjectId();
                    if (!this.projectId) {
                        this.showError('ì˜¬ë°”ë¥¸ í”„ë¡œì íŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>ì‚¬ìš©ë²•: /onlyrun/í”„ë¡œì íŠ¸ID');
                        return;
                    }
                    
                    // 2. Entry.js ì´ˆê¸°í™”
                    this.updateLoadingText('Entry.js ì´ˆê¸°í™” ì¤‘...', 'ì—”ì§„ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤');
                    await this.initEntry();
                    
                    // 3. í”„ë¡œì íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    this.updateLoadingText('í”„ë¡œì íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘...', `í”„ë¡œì íŠ¸ ID: ${this.projectId}`);
                    const projectData = await this.fetchProject(this.projectId);
                    
                    // 4. í”„ë¡œì íŠ¸ ë¡œë“œ ë° ì‹¤í–‰
                    this.updateLoadingText('í”„ë¡œì íŠ¸ ì‹¤í–‰ ì¤‘...', projectData.name || 'ì œëª© ì—†ìŒ');
                    await this.loadAndRunProject(projectData);
                    
                    console.log('ğŸš€ OnlyRun ëª¨ë“œë¡œ í”„ë¡œì íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    console.log('í”„ë¡œì íŠ¸:', projectData.name);
                    console.log('ì œì‘ì:', projectData.user?.nickname);
                    
                } catch (error) {
                    console.error('OnlyRun ëª¨ë“œ ì‹¤í–‰ ì‹¤íŒ¨:', error);
                    this.showError(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:<br>${error.message}<br><br>í”„ë¡œì íŠ¸ IDë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                }
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', () => {
            const onlyRun = new OnlyRunMode();
            onlyRun.run();
        });
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ESCë¡œ ì „ì²´í™”ë©´ í† ê¸€ ë“±)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            }
        });
    </script>
</body>
</html> 