<!DOCTYPE html>
<html lang="ko">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Entry.js OnlyRun Mode</title>
    <link href="dist/entry.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .loading-detail {
            font-size: 14px;
            opacity: 0.8;
        }
        
        #error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .error-message {
            font-size: 16px;
            opacity: 0.9;
            max-width: 600px;
            line-height: 1.5;
        }
        
        #workspace {
            width: 100vw;
            height: 100vh;
            display: none;
        }
        
        /* Entry.js 스테이지를 전체 화면으로 */
        .entryStageWrapper {
            width: 100% !important;
            height: 100% !important;
        }
        
        .entryStage {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* 불필요한 UI 요소들 숨기기 */
        .entryPlayground,
        .entryPropertyPanel,
        .entryMenubar,
        .entryToolbar {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 로딩 화면 -->
    <div id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">프로젝트를 불러오는 중...</div>
        <div class="loading-detail">잠시만 기다려주세요</div>
    </div>
    
    <!-- 에러 화면 -->
    <div id="error">
        <div class="error-icon">⚠️</div>
        <div class="error-title">프로젝트를 불러올 수 없습니다</div>
        <div class="error-message" id="error-message">
            올바른 프로젝트 ID를 확인해주세요.<br>
            사용법: /onlyrun/프로젝트ID
        </div>
    </div>
    
    <!-- Entry.js 워크스페이스 -->
    <div id="workspace"></div>

    <!-- Entry.js 의존성 라이브러리들 -->
    <script src="extern/lang/ko.js"></script>
    <script src="https://playentry.org/lib/PreloadJS/lib/preloadjs-0.6.0.min.js"></script>
    <script src="https://playentry.org/lib/EaselJS/lib/easeljs-0.8.0.min.js"></script>
    <script src="https://playentry.org/lib/SoundJS/lib/soundjs-0.6.0.min.js"></script>
    <script src="https://playentry.org/lib/SoundJS/lib/flashaudioplugin-0.6.0.min.js"></script>
    <script src="https://playentry.org/lib/lodash/dist/lodash.min.js"></script>
    <script src="https://playentry.org/lib/jquery/jquery.min.js"></script>
    <script src="https://playentry.org/lib/jquery-ui/ui/minified/jquery-ui.min.js"></script>
    <script src="https://playentry.org/lib/velocity/velocity.min.js"></script>
    <script src="extern/util/static.js"></script>
    <script src="dist/entry.js"></script>

    <script>
        // OnlyRun 모드 구현
        class OnlyRunMode {
            constructor() {
                this.projectId = null;
                this.loadingEl = document.getElementById('loading');
                this.errorEl = document.getElementById('error');
                this.workspaceEl = document.getElementById('workspace');
                this.errorMessageEl = document.getElementById('error-message');
            }
            
            // URL에서 프로젝트 ID 추출
            extractProjectId() {
                const path = window.location.pathname;
                const match = path.match(/\/onlyrun\/([a-zA-Z0-9]+)/);
                return match ? match[1] : null;
            }
            
            // 로딩 상태 업데이트
            updateLoadingText(text, detail = '') {
                document.querySelector('.loading-text').textContent = text;
                document.querySelector('.loading-detail').textContent = detail;
            }
            
            // 에러 표시
            showError(message) {
                this.errorMessageEl.innerHTML = message;
                this.loadingEl.style.display = 'none';
                this.errorEl.style.display = 'flex';
            }
            
            // 이미지 파일명을 절대 URL로 변환
            convertImageUrl(filename) {
                if (!filename || filename.length < 4) return filename;
                
                const prefix1 = filename.substring(0, 2);
                const prefix2 = filename.substring(2, 4);
                const extension = filename.split('.').pop() || 'png';
                
                return `https://playentry.org/uploads/${prefix1}/${prefix2}/image/${filename}`;
            }
            
            // 프로젝트 데이터에서 이미지 URL 변환
            processProjectData(projectData) {
                if (!projectData || !projectData.objects) return projectData;
                
                // 오브젝트들의 이미지 파일명을 절대 URL로 변환
                projectData.objects.forEach(obj => {
                    if (obj.sprite && obj.sprite.pictures) {
                        obj.sprite.pictures.forEach(picture => {
                            if (picture.filename) {
                                picture.fileurl = this.convertImageUrl(picture.filename);
                            }
                        });
                    }
                    if (obj.sprite && obj.sprite.sounds) {
                        obj.sprite.sounds.forEach(sound => {
                            if (sound.filename) {
                                sound.fileurl = this.convertImageUrl(sound.filename);
                            }
                        });
                    }
                });
                
                return projectData;
            }
            
            // Entry.org GraphQL API로 프로젝트 데이터 가져오기
            async fetchProject(projectId) {
                const query = `
                    query SELECT_PROJECT($id: ID! $groupId: ID) {
                        project(id: $id, groupId: $groupId) {
                            id
                            name
                            user {
                                id
                                nickname
                                profileImage {
                                    id
                                    name
                                    filename
                                    imageType
                                    dimension {
                                        width
                                        height
                                    }
                                }
                            }
                            thumb
                            isopen
                            category
                            created
                            updated
                            visit
                            likeCnt
                            comment
                            description
                            speed
                            objects
                            variables
                            messages
                            functions
                            tables
                            scenes
                            expansionBlocks
                            aiUtilizeBlocks
                        }
                    }
                `;
                
                const response = await fetch('https://playentry.org/graphql/SELECT_PROJECT', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': '*/*',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: { id: projectId }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.errors) {
                    throw new Error(result.errors[0].message);
                }
                
                if (!result.data || !result.data.project) {
                    throw new Error('프로젝트를 찾을 수 없습니다.');
                }
                
                return result.data.project;
            }
            
                         // Entry.js 초기화
             initEntry() {
                 return new Promise((resolve, reject) => {
                     try {
                         const initOption = {
                             type: 'workspace', // 워크스페이스 모드로 초기화 후 UI 숨김
                             libDir: '',
                             entryDir: '',
                             textCodingEnable: false,
                             hardwareEnable: false,
                         };
                         
                         Entry.init(this.workspaceEl, initOption);
                         
                         // UI 요소들 숨기기
                         setTimeout(() => {
                             this.hideUIElements();
                             resolve();
                         }, 1500);
                         
                     } catch (error) {
                         reject(error);
                     }
                 });
             }
             
             // UI 요소들 숨기기
             hideUIElements() {
                 const elementsToHide = [
                     '.entryPlayground',
                     '.entryPropertyPanel', 
                     '.entryMenubar',
                     '.entryToolbar',
                     '.entryCanvasWrapper .entryCanvasWorkspace',
                     '.entryWorkspaceBoard',
                     '.entryBlocklyWorkspace'
                 ];
                 
                 elementsToHide.forEach(selector => {
                     const elements = document.querySelectorAll(selector);
                     elements.forEach(el => {
                         el.style.display = 'none';
                     });
                 });
                 
                 // 스테이지만 전체 화면으로 표시
                 const stage = document.querySelector('.entryCanvasStage');
                 if (stage) {
                     stage.style.position = 'fixed';
                     stage.style.top = '0';
                     stage.style.left = '0';
                     stage.style.width = '100vw';
                     stage.style.height = '100vh';
                     stage.style.zIndex = '1000';
                 }
             }
            
            // 프로젝트 로드 및 실행
            async loadAndRunProject(projectData) {
                try {
                    // 프로젝트 데이터 처리
                    const processedData = this.processProjectData(projectData);
                    
                    // Entry.js에 프로젝트 로드
                    Entry.loadProject(processedData);
                    
                    // 자동 실행
                    setTimeout(() => {
                        if (Entry.engine) {
                            Entry.engine.run();
                        }
                    }, 500);
                    
                    // UI 전환
                    this.loadingEl.style.display = 'none';
                    this.workspaceEl.style.display = 'block';
                    
                } catch (error) {
                    throw new Error(`프로젝트 로드 실패: ${error.message}`);
                }
            }
            
            // 메인 실행 함수
            async run() {
                try {
                    // 1. 프로젝트 ID 추출
                    this.projectId = this.extractProjectId();
                    if (!this.projectId) {
                        this.showError('올바른 프로젝트 ID를 입력해주세요.<br>사용법: /onlyrun/프로젝트ID');
                        return;
                    }
                    
                    // 2. Entry.js 초기화
                    this.updateLoadingText('Entry.js 초기화 중...', '엔진을 준비하고 있습니다');
                    await this.initEntry();
                    
                    // 3. 프로젝트 데이터 가져오기
                    this.updateLoadingText('프로젝트 데이터 가져오는 중...', `프로젝트 ID: ${this.projectId}`);
                    const projectData = await this.fetchProject(this.projectId);
                    
                    // 4. 프로젝트 로드 및 실행
                    this.updateLoadingText('프로젝트 실행 중...', projectData.name || '제목 없음');
                    await this.loadAndRunProject(projectData);
                    
                    console.log('🚀 OnlyRun 모드로 프로젝트가 성공적으로 로드되었습니다!');
                    console.log('프로젝트:', projectData.name);
                    console.log('제작자:', projectData.user?.nickname);
                    
                } catch (error) {
                    console.error('OnlyRun 모드 실행 실패:', error);
                    this.showError(`오류가 발생했습니다:<br>${error.message}<br><br>프로젝트 ID를 확인하거나 잠시 후 다시 시도해주세요.`);
                }
            }
        }
        
        // 페이지 로드 완료 후 실행
        window.addEventListener('DOMContentLoaded', () => {
            const onlyRun = new OnlyRunMode();
            onlyRun.run();
        });
        
        // 키보드 단축키 (ESC로 전체화면 토글 등)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            }
        });
    </script>
</body>
</html> 